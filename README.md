# Ruijie-ePorta-Tool
一个基于 Python3 的自动登录/断开锐捷 ePorta Web 网页认证的工具（可开关功能，理论支持大部分学校）

#### 权责声明
- 本脚本仅供研究学习之用，无意对锐捷的认证机制做任何抵触性行为。
- 本脚本不可用于任何商业和不良用途，否则责任自负。
- 本脚本不保证在任何环境下能够通过，本人也不保证能按时按网友要求改进本脚本，其编写及维护纯属个人爱好，有可能随时被终止。
- 本脚本不保证经过严格测试对机器无害，由于未知的使用环境或不当的使用对计算机造成的损害，责任由使用者全部承担。
- 由于任何不遵守上叙条例引起的纠纷，均与本人无关

## 简介
- 本脚本实现了锐捷 ePortal Web 认证的登录/下线功能，不依赖 `curl` 命令，通过 Python3 的 requests 库来发送 POST 请求实现联网登录与断网下线。
- 理论上本脚本支持已安装 Python3 的 Windows、Linux、MacOS 等操作系统

## 特性
- 运行时自动判断网络通断，网络通则询问是否需要断网（可控制开关，若关闭该功能则网络通时自动退出），网络不通则自动进行联网
- 运行时自动判断当前连接的网络是否是校园网（若校园网服务器不允许 ping 则要在配置文件中关闭该功能）
- 可根据配置文件内容动态调整登录/下线时使用的 登陆页面、HTML Header、传递的参数、cookie
- 理论上可适配所有登录不需要验证码的学校

## 使用方法
### 一、获取联网所需信息
1. 安装 [`Wireshark`](https://www.wireshark.org/download.html) 或其他的抓包软件，在断网的情况下打开校园网登录页面，填写信息并勾选保存密码
2. 开始抓包，点击登录页面的登录按钮，成功登录后停止抓包
3. 运行本脚本生成配置文件，在 `Wireshark` 中找到登录时发送的数据包，将相关信息填写至配置文件中

### 二、获取断网所需信息
1. 联网情况下打开校园网联网成功页面
2. 开始抓包，点击页面右上角的的`下线`按钮，成功下线后停止抓包
3. 在 `Wireshark` 中找到下线时发送的数据包，将相关信息填写至配置文件中

### 三、正常使用
在填写相关信息后应该可以正常使用，若不可以使用，请正确填写配置信息（可增加或删除参数和 HTML Headr。某些学校必须填写 `Referer` 项），也有可能是暂时还不适配你所在的学校，可以把数据包脱敏后提交 issue 给我分析。

### Tips
- 使用 Wi-Fi 连接校园网则建议关闭随机 MAC 地址
> Windows 10 系统中该选项位于：系统设置 - 网络和 Internet - WLAN - 管理已知网络 - <你所在学校的校园网无线 SSID> - 属性 - 对此网络使用随机地址
- 开机启动可创建快捷方式/符号链接（软链接）并复制到启动目录
- 可以通过关闭断网提醒并添加至任务计划以定期检查防止设备断网
- 某些 Windows 设备运行本脚本的 exe 版本可能需要安装 `Visual C++ 可再发行软件包 2015-2019` ，实在打不开建议 clone 本仓库后自行构建
> VC++ 安装包：  
> &emsp;&emsp;[果壳剥壳 - 微软常用运行库合集](https://www.ghpym.com/yxkhj.html)  
> &emsp;&emsp;[微软官方 - 各版本 Visual C++ 下载合集](https://support.microsoft.com/zh-cn/help/2977003/the-latest-supported-visual-c-downloads)

## Build 构建
1. clone 本仓库;
2. 安装 `pyinstaller` : 在正确安装并配置好 python 3 环境的 Windows 设备上以管理员权限运行命令提示符或 Powershell 后执行`pip install pyinstaller`;
3. 运行脚本 `build.bat` （支持 upx 压缩） 
4. 待命令执行完毕后可在 `dist` 文件夹找到构建好的 exe 文件

## 局限性
锐捷 ePortal Web 认证的 POST 数据包中存在 `validcode` 参数，这个参数应该是图形验证码。我所在的学校并没有开启验证码，只有在登录尝试次数过多的时候才会出现验证码。如果你的学校在登录的时候需要验证码，那么本脚本将无法进行认证。

本人是 Python 初学者，代码冗余杂乱，可能运行效率不高。目前受限于本人技术水平以及不想盲目包含更多的库，Windows 系统在运行本软件时可能会闪过 CMD 窗口，这属于正常现象，忽略即可。

曾尝试过用 requests 库请求外网主机获取 IP 地址的方式检测网络是否通畅，但是断网情况下有时候会导致程序运行时假死（在 Pycharm 中直接运行也会偶发）且超时时间无法设置（已经尝试过很多方法改超时时间但都没有用），最后还是换成使用 `ping` 命令，这会导致在 Windows 系统中断网时检测网络是否连通会显示一段时间 CMD 窗口。
> 如果有大神能改进的话可以提交 pull requests

## 测试环境
- Python 环境: Anaconda3 64-bit (Python 3.8.5)
- 系统: Windows 10 专业版 (19041.508)
- 连接方式：有线连接
- 学校：佛山科学技术学院仙溪校区
- 时间：2020/09
